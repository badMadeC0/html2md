
name: ci
on:
  push:
  pull_request:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
permissions:
  contents: read
jobs:
  test:
    if: >
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (
        (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
        contains(github.event.comment.body, '@claude')
      )
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -e .
          pip install pytest
      - name: Test
        run: pytest -q

  claude-respond:
    if: >
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -e "."
      - name: Respond to @claude mention
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          THREAD_TITLE: ${{ github.event.issue.title || github.event.pull_request.title }}
          THREAD_BODY: ${{ github.event.issue.body || github.event.pull_request.body }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'SCRIPT'
          import os
          import subprocess
          import anthropic

          allowed_associations = {"OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"}
          comment_author = os.environ.get("COMMENT_AUTHOR", "unknown")
          author_association = os.environ.get("COMMENT_AUTHOR_ASSOCIATION", "NONE")
          if author_association not in allowed_associations:
              raise SystemExit(
                  "Skipping @claude response for comment author "
                  f"'{comment_author}' with association '{author_association}'."
              )

          comment = os.environ.get("COMMENT_BODY", "").strip()
          if not comment:
              raise SystemExit("COMMENT_BODY environment variable is not set or empty.")
          max_comment_chars = 4000
          if len(comment) > max_comment_chars:
              comment = comment[:max_comment_chars]

          thread_title = os.environ.get("THREAD_TITLE", "")
          thread_body = os.environ.get("THREAD_BODY", "")
          issue_number = os.environ.get("ISSUE_NUMBER", "").strip()
          if not issue_number:
              raise SystemExit("ISSUE_NUMBER environment variable is not set or empty; cannot post reply comment.")
          repo = os.environ["REPO"]

          api_key = os.environ.get("ANTHROPIC_API_KEY")
          if not api_key:
              raise SystemExit(
                  "Error: ANTHROPIC_API_KEY environment variable is not set. "
                  "Please configure the ANTHROPIC_API_KEY secret in your GitHub repository settings."
              )

          try:
              client = anthropic.Anthropic(api_key=api_key)
              response = client.messages.create(
                  model="claude-sonnet-4-5-20250929",
                  max_tokens=1024,
                  messages=[
                      {
                          "role": "user",
                          "content": (
                              f"You are a helpful assistant for the GitHub repository {repo}. "
                              f"A user mentioned you in a comment. Respond concisely and helpfully.\n\n"
                              f"Thread title:\n{thread_title}\n\n"
                              f"Thread description:\n{thread_body}\n\n"
                              f"Comment:\n{comment}"
                          ),
                      }
                  ],
              )
          except Exception as exc:
              raise SystemExit(f"Error: Failed to call Anthropic API: {exc}")
          default_reply = "Sorry, I wasn't able to generate a response."
          reply = default_reply
          content = getattr(response, "content", None)
          if isinstance(content, list) and content:
              first_item = content[0]
              text = getattr(first_item, "text", None)
              if isinstance(text, str) and text.strip():
                  reply = text

          # Guardrails for content posted back to GitHub.
          reply = reply.replace("\x00", "").strip()
          max_reply_chars = 5000
          if len(reply) > max_reply_chars:
              reply = f"{reply[:max_reply_chars]}\n\n[Response truncated to {max_reply_chars} characters.]"

          # Post reply via GitHub API
          result = subprocess.run(
              [
                  "gh", "api",
                  f"repos/{repo}/issues/{issue_number}/comments",
                  "-f", f"body={reply}",
              ],
              env={**os.environ, "GH_TOKEN": os.environ["GITHUB_TOKEN"]},
              capture_output=True,
              text=True,
          )
          if result.returncode != 0:
              raise SystemExit(
                  "Error: Failed to post GitHub comment via gh api. "
                  f"stdout: {result.stdout.strip()} stderr: {result.stderr.strip()}"
              )

          if result.stdout.strip():
              print(result.stdout.strip())
          if result.stderr.strip():
              print(result.stderr.strip())
          SCRIPT
