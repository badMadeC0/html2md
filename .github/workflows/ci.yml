
name: ci
on:
  push:
  pull_request:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
permissions:
  contents: read
  issues: write
  pull-requests: write
jobs:
  test:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -e "."
          pip install pytest
      - name: Test
        run: pytest -q

  claude-respond:
    if: >
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install anthropic
      - name: Respond to @claude mention
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'SCRIPT'
          import os
          import subprocess
          import anthropic

          comment = os.environ["COMMENT_BODY"]
          issue_number = os.environ.get("ISSUE_NUMBER", "").strip()
          if not issue_number:
              raise SystemExit("ISSUE_NUMBER environment variable is not set or empty; cannot post reply comment.")
          repo = os.environ["REPO"]

          client = anthropic.Anthropic()
          response = client.messages.create(
              model="claude-sonnet-4-5-20250929",
              max_tokens=1024,
              messages=[
                  {
                      "role": "user",
                      "content": (
                          f"You are a helpful assistant for the GitHub repository {repo}. "
                          f"A user mentioned you in a comment. Respond concisely and helpfully.\n\n"
                          f"Comment:\n{comment}"
                      ),
                  }
              ],
          )

          reply = response.content[0].text

          # Post reply via GitHub API
          subprocess.run(
              [
                  "gh", "api",
                  f"repos/{repo}/issues/{issue_number}/comments",
                  "-f", f"body={reply}",
              ],
              env={**os.environ, "GH_TOKEN": os.environ["GITHUB_TOKEN"]},
              check=True,
          )
          SCRIPT
