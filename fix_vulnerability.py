import re

file_path = "gui-url-convert.ps1"

with open(file_path, "r", encoding="utf-8") as f:
    content = f.read()

# Fix Batch Mode Relaunch
# Original: .Arguments = "-NoExit -ExecutionPolicy Bypass -File " -BatchFile " -BatchOutDir ""
# We want to sanitize  (and tempFile just in case, though it's generated safely).
# Since  is user input, it could contain quotes.

batch_fix = r'''        # Escape double quotes for command line safety
        $safeTempFile = $tempFile -replace '"', '\"'
        $safeOutDir = $outdir -replace '"', '\"'
        $psi.Arguments = "-NoExit -ExecutionPolicy Bypass -File `"$PSCommandPath`" -BatchFile `"$safeTempFile`" -BatchOutDir `"$safeOutDir`""
        # Relaunch this script in batch mode
'''

# Replace the original batch line. Note: need to escape special regex chars.
batch_pattern = r'\s+\$psi\.Arguments = "-NoExit -ExecutionPolicy Bypass -File " -BatchFile " -BatchOutDir ""'
match_batch = re.search(batch_pattern, content)
if match_batch:
    original_batch = match_batch.group(0)
    # We replace it. But we need to handle indentation.
    # The replacement string has indentation baked in?
    # Let's adjust indentation dynamically.
    indent = original_batch[:original_batch.find('$')]
    batch_fix_indented = batch_fix.replace('\n        ', '\n' + indent)
    # Actually, my batch_fix string has 8 spaces.
    content = content.replace(original_batch, batch_fix_indented)
else:
    print("Warning: Could not find Batch Mode line.")

# Fix Single URL Mode
# Original:
#         if (Test-Path -LiteralPath ) {
#             .AppendText("Found venv executable: n")
#             .Arguments = "-NoExit -Command ""
#         }
#         elseif (Test-Path -LiteralPath ) {
#             .AppendText("Found Python script: n")
#             .Arguments = "-NoExit -Command ""
#         }

# We want to insert sanitization before this block.
single_mode_start = r'# --- SINGLE URL MODE ---'
sanitization_code = r'''        # --- SINGLE URL MODE ---
         = [0]
        # Sanitize inputs for single-quoted string interpolation
         =  -replace "'", "''"
         =  -replace "'", "''"
         =  -replace "'", "''"
         =  -replace "'", "''"'''

content = content.replace(r'# --- SINGLE URL MODE ---' + '\n         = [0]', sanitization_code)

# Now update the usage of variables in the arguments
# Note: internal single quotes are what matters.
# Using regex to replace the variable names in the Arguments assignment lines.

# Update the usage of variables in the Arguments assignment lines using regex.
# Replace $venvExe with $safeVenv in the first $psi.Arguments assignment
content = re.sub(r"(\$psi\\.Arguments = \"-NoExit -Command `\"& ')\\$venvExe(' --url)", r"\1$safeVenv\2", content, flags=re.DOTALL)
# Replace $url with $safeUrl in both $psi.Arguments assignments
content = re.sub(r"(--url ')\\$url(' --outdir)", r"\1$safeUrl\2", content, flags=re.DOTALL)
# Replace $outdir with $safeOutDir in both $psi.Arguments assignments
content = re.sub(r"(--outdir ')\\$outdir(' --all-formats)", r"\1$safeOutDir\2", content, flags=re.DOTALL)
# Replace $pyScript with $safePyScript in the second $psi.Arguments assignment
content = re.sub(r"(\$psi\\.Arguments = \"-NoExit -Command `\"& \$pyCmd ')\\$pyScript(' --url)", r"\1$safePyScript\2", content, flags=re.DOTALL)

with open(file_path, "w", encoding="utf-8") as f:
    f.write(content)

print("Applied fixes to gui-url-convert.ps1")
