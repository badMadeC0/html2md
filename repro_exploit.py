import sys

def simulate_ps_command(url, outdir, venv_exe):
    # This simulates exactly what PowerShell does with string interpolation:
    # ".Arguments = \"-NoExit -Command \"\""

    # The effective command passed to PowerShell is:
    # & 'venv_exe' --url 'url' --outdir 'outdir' --all-formats

    return f"& '{venv_exe}' --url '{url}' --outdir '{outdir}' --all-formats"

def analyze_command(command_str):
    print(f"Generated Command: {command_str}")

    # We look for the pattern where the malicious payload breaks out of the quotes.
    # A safe command would have the entire URL inside single quotes.
    # An unsafe command has '; Calc; ' outside the quotes.

    # Simple heuristic: Does it contain unescaped semicolons that are not inside quotes?
    # Since we know the input, we can check if the payload structure is visible.

    if "'; Calc; '" in command_str:
        print("[!] VULNERABILITY CONFIRMED: Injection payload found outside of quotes context.")
        return True
    return False

malicious_url = "http://example.com'; Calc; '"
outdir = "C:\Output"
venv_exe = "C:\Path\To\html2md.exe"

print("--- Simulating Vulnerable Code ---")
cmd = simulate_ps_command(malicious_url, outdir, venv_exe)
analyze_command(cmd)

print("\n--- Simulating Fix ---")
# Apply fix: escape single quotes by doubling them
safe_url = malicious_url.replace("'", "''")
safe_outdir = outdir.replace("'", "''")
safe_venv = venv_exe.replace("'", "''")

cmd_fixed = f"& '{safe_venv}' --url '{safe_url}' --outdir '{safe_outdir}' --all-formats"
print(f"Fixed Command: {cmd_fixed}")

if "'; Calc; '" in cmd_fixed:
    print("[!] VULNERABILITY PERSISTS")
else:
    print("[+] Fix successful: Payload is contained within escaped quotes.")
    # Verify the string content would be interpreted correctly
    # PowerShell sees '...''...''...' as a single string with literal single quotes.
    expected_segment = "'http://example.com''; Calc; '''"
    if expected_segment in cmd_fixed:
        print(f"    (Verified: PowerShell will read this as the literal string: {malicious_url})")
